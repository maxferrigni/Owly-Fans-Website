<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owly Fans</title>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <!-- React Development Dependencies (for better error messages) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
    
    <!-- Supabase (before React component) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Verify script loading -->
    <script>
        window.addEventListener('load', function() {
            console.log('React loaded:', !!window.React);
            console.log('ReactDOM loaded:', !!window.ReactDOM);
            console.log('Supabase loaded:', !!window.supabaseClient);
            console.log('Tailwind loaded:', !!window.tailwind);
        });
    </script>

    <!-- Your original styles -->
    <style>
        /* Add debugging outline */
        .subscription-container {
            outline: 2px solid transparent; /* Only visible when debugging needed */
            margin: 20px auto;
            max-width: 500px;
            padding: 20px;
            position: relative; /* Ensure proper stacking */
            z-index: 1; /* Ensure visibility */
        }

        /* Rest of your original styles */
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        /* ... rest of your existing styles ... */
    </style>
</head>
<body>
    <h1 style="font-size: 3em; font-weight: bold;">Welcome to OWLY FANS!</h1>

    <!-- Your existing content -->
    
    <!-- Test component to verify React is working -->
    <div id="react-test"></div>
    
    <!-- Subscription Form with clear visibility -->
    <div id="subscription-form" class="subscription-container">
        <!-- Fallback content if React fails -->
        <noscript>You need to enable JavaScript to see the subscription form.</noscript>
    </div>

    <!-- Rest of your content -->

    <!-- Initialize React with error checking -->
    <script type="text/babel">
        // Verify React hooks are available
        const { useState } = React;
        console.log('React hooks available:', !!useState);

        // Test component to verify React rendering
        const TestComponent = () => {
            return <div className="text-4xl">React is working!</div>;
        };

        // Try rendering test component
        try {
            const testRoot = ReactDOM.createRoot(document.getElementById('react-test'));
            testRoot.render(<TestComponent />);
            console.log('Test component rendered successfully');
            // Hide test component after confirming React works
            setTimeout(() => {
                document.getElementById('react-test').style.display = 'none';
            }, 1000);
        } catch (error) {
            console.error('Error rendering test component:', error);
        }

        // Supabase Configuration
        const SUPABASE_URL = 'https://kketfaaihwjflpdngtvo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZXRmYWFpaHdqZmxwZG5ndHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzczMTg1MTAsImV4cCI6MjA1Mjg5NDUxMH0.PYKJKO39GCAXm-3zDFnQbSy1-oc4iuE4neLnfItIC90';

        // Subscription Form Component
        const SubscriptionForm = () => {
            console.log('SubscriptionForm component initializing');

            // Initialize state with error checking
            try {
                const [email, setEmail] = useState('');
                const [captchaAnswer, setCaptchaAnswer] = useState('');
                const [status, setStatus] = useState('');
                const [isSubmitting, setIsSubmitting] = useState(false);
                const [captchaQuestion, setCaptchaQuestion] = useState(() => {
                    const num1 = Math.floor(Math.random() * 10) + 1;
                    const num2 = Math.floor(Math.random() * 10) + 1;
                    return { num1, num2, answer: num1 + num2 };
                });

                // Initialize Supabase with error checking
                let supabase;
                try {
                    supabase = supabaseClient.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('Supabase client initialized successfully');
                } catch (error) {
                    console.error('Error initializing Supabase:', error);
                    return <div>Error initializing form. Please try again later.</div>;
                }

                // Form submission handler
                const handleSubmit = async (e) => {
                    e.preventDefault();
                    
                    // Validate email format
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        setStatus('invalid-email');
                        return;
                    }

                    // Validate captcha
                    if (parseInt(captchaAnswer) !== captchaQuestion.answer) {
                        setStatus('captcha-error');
                        return;
                    }

                    try {
                        setIsSubmitting(true);

                        // Check if email already exists
                        const { data: existingUser } = await supabase
                            .from('subscribers')
                            .select('email')
                            .eq('email', email.toLowerCase().trim())
                            .single();

                        if (existingUser) {
                            setStatus('already-subscribed');
                            return;
                        }

                        // Insert new subscriber
                        const { error } = await supabase
                            .from('subscribers')
                            .insert([{ 
                                email: email.toLowerCase().trim(),
                                preferences: { email: true, sms: false }
                            }]);

                        if (error) throw error;

                        // Success
                        setStatus('success');
                        setEmail('');
                        setCaptchaAnswer('');
                        
                        // Generate new captcha
                        const num1 = Math.floor(Math.random() * 10) + 1;
                        const num2 = Math.floor(Math.random() * 10) + 1;
                        setCaptchaQuestion({ num1, num2, answer: num1 + num2 });

                    } catch (error) {
                        console.error('Subscription error:', error);
                        setStatus('error');
                    } finally {
                        setIsSubmitting(false);
                    }
                };

                // Render form with Tailwind test class
                return (
                    <div className="max-w-md mx-auto p-6 bg-white rounded-lg shadow-sm">
                        <h2 className="text-xl font-bold mb-4 text-center">Subscribe to Owl Updates</h2>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
                                    Email Address
                                </label>
                                <input
                                    type="email"
                                    id="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    disabled={isSubmitting}
                                    required
                                />
                            </div>

                            <div>
                                <label htmlFor="captcha" className="block text-sm font-medium text-gray-700 mb-1">
                                    What is {captchaQuestion.num1} + {captchaQuestion.num2}?
                                </label>
                                <input
                                    type="number"
                                    id="captcha"
                                    value={captchaAnswer}
                                    onChange={(e) => setCaptchaAnswer(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    disabled={isSubmitting}
                                    required
                                />
                            </div>

                            <button
                                type="submit"
                                className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
                                disabled={isSubmitting}
                            >
                                {isSubmitting ? 'Subscribing...' : 'Subscribe'}
                            </button>
                        </form>

                        {status === 'success' && (
                            <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-md">
                                <p className="text-green-700">Successfully subscribed! Check your email for updates.</p>
                            </div>
                        )}

                        {status === 'already-subscribed' && (
                            <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-md">
                                <p className="text-yellow-700">This email is already subscribed to updates!</p>
                            </div>
                        )}

                        {status === 'invalid-email' && (
                            <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-md">
                                <p className="text-red-700">Please enter a valid email address.</p>
                            </div>
                        )}

                        {status === 'captcha-error' && (
                            <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-md">
                                <p className="text-red-700">Incorrect answer. Please try again.</p>
                            </div>
                        )}

                        {status === 'error' && (
                            <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-md">
                                <p className="text-red-700">An error occurred. Please try again later.</p>
                            </div>
                        )}
                    </div>
                );
            } catch (error) {
                console.error('Error in SubscriptionForm component:', error);
                return <div>Error initializing form. Please try again later.</div>;
            }
        };

        // Render SubscriptionForm with error checking
        try {
            console.log('Attempting to render SubscriptionForm');
            const formContainer = document.getElementById('subscription-form');
            if (!formContainer) {
                throw new Error('Subscription form container not found');
            }
            const root = ReactDOM.createRoot(formContainer);
            root.render(<SubscriptionForm />);
            console.log('SubscriptionForm rendered successfully');
        } catch (error) {
            console.error('Error rendering SubscriptionForm:', error);
            document.getElementById('subscription-form').innerHTML = 'Error loading form. Please try again later.';
        }
    </script>
</body>
</html>
