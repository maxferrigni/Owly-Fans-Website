<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owly Fans</title>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <!-- Add React and required dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
    <!-- Add Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Add Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Your original styles here -->
    <style>
        /* Your existing styles */
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        /* ... rest of your original styles ... */
    </style>
</head>
<body>
    <!-- Your existing HTML content -->
    <h1 style="font-size: 3em; font-weight: bold;">Welcome to OWLY FANS!</h1>
    
    <!-- Keep all your existing content up to the subscription form -->

    <!-- Subscription Form -->
    <div id="subscription-form" class="subscription-container"></div>

    <!-- Rest of your existing content -->
    
    <!-- React Component Script -->
    <script type="text/babel">
        // Import and use React hooks
        const { useState } = React;

        // Supabase configuration
        const SUPABASE_URL = 'https://kketfaaihwjflpdngtvo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZXRmYWFpaHdqZmxwZG5ndHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzczMTg1MTAsImV4cCI6MjA1Mjg5NDUxMH0.PYKJKO39GCAXm-3zDFnQbSy1-oc4iuE4neLnfItIC90';
        
        const SubscriptionForm = () => {
            const [email, setEmail] = useState('');
            const [captchaAnswer, setCaptchaAnswer] = useState('');
            const [status, setStatus] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [captchaQuestion, setCaptchaQuestion] = useState(() => {
                const num1 = Math.floor(Math.random() * 10) + 1;
                const num2 = Math.floor(Math.random() * 10) + 1;
                return { num1, num2, answer: num1 + num2 };
            });

            // Initialize Supabase client
            const supabase = supabaseClient.createClient(SUPABASE_URL, SUPABASE_KEY);

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    setStatus('invalid-email');
                    return;
                }

                // Validate captcha
                if (parseInt(captchaAnswer) !== captchaQuestion.answer) {
                    setStatus('captcha-error');
                    return;
                }

                try {
                    setIsSubmitting(true);

                    // Check if email already exists
                    const { data: existingUser } = await supabase
                        .from('subscribers')
                        .select('email')
                        .eq('email', email.toLowerCase().trim())
                        .single();

                    if (existingUser) {
                        setStatus('already-subscribed');
                        return;
                    }

                    // Insert new subscriber
                    const { error } = await supabase
                        .from('subscribers')
                        .insert([{ 
                            email: email.toLowerCase().trim(),
                            preferences: { email: true, sms: false }
                        }]);

                    if (error) throw error;

                    // Success
                    setStatus('success');
                    setEmail('');
                    setCaptchaAnswer('');
                    
                    // Generate new captcha
                    const num1 = Math.floor(Math.random() * 10) + 1;
                    const num2 = Math.floor(Math.random() * 10) + 1;
                    setCaptchaQuestion({ num1, num2, answer: num1 + num2 });

                } catch (error) {
                    console.error('Subscription error:', error);
                    setStatus('error');
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="max-w-md mx-auto p-6 bg-white rounded-lg shadow-sm">
                    <h2 className="text-xl font-bold mb-4 text-center">Subscribe to Owl Updates</h2>
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
                                Email Address
                            </label>
                            <input
                                type="email"
                                id="email"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                disabled={isSubmitting}
                                required
                            />
                        </div>

                        <div>
                            <label htmlFor="captcha" className="block text-sm font-medium text-gray-700 mb-1">
                                What is {captchaQuestion.num1} + {captchaQuestion.num2}?
                            </label>
                            <input
                                type="number"
                                id="captcha"
                                value={captchaAnswer}
                                onChange={(e) => setCaptchaAnswer(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                disabled={isSubmitting}
                                required
                            />
                        </div>

                        <button
                            type="submit"
                            className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
                            disabled={isSubmitting}
                        >
                            {isSubmitting ? 'Subscribing...' : 'Subscribe'}
                        </button>
                    </form>

                    {status === 'success' && (
                        <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-md">
                            <p className="text-green-700">Successfully subscribed! Check your email for updates.</p>
                        </div>
                    )}

                    {status === 'already-subscribed' && (
                        <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-md">
                            <p className="text-yellow-700">This email is already subscribed to updates!</p>
                        </div>
                    )}

                    {status === 'invalid-email' && (
                        <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-md">
                            <p className="text-red-700">Please enter a valid email address.</p>
                        </div>
                    )}

                    {status === 'captcha-error' && (
                        <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-md">
                            <p className="text-red-700">Incorrect answer. Please try again.</p>
                        </div>
                    )}

                    {status === 'error' && (
                        <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-md">
                            <p className="text-red-700">An error occurred. Please try again later.</p>
                        </div>
                    )}
                </div>
            );
        };

        // Render the SubscriptionForm component
        const root = ReactDOM.createRoot(document.getElementById('subscription-form'));
        root.render(<SubscriptionForm />);
    </script>
</body>
</html>
